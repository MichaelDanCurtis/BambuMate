---
phase: 01-app-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/pages/settings.rs
  - src/pages/health.rs
  - src/components/api_key_form.rs
  - src/components/status_badge.rs
  - src/components/mod.rs
  - style/main.css
autonomous: false

must_haves:
  truths:
    - "User can enter and save API keys via the Settings page, and keys persist across app restarts"
    - "User can run a health check that reports Bambu Studio installation, profile directory, and API key status"
    - "App builds to a distributable macOS .dmg that installs and runs"
  artifacts:
    - path: "src/pages/settings.rs"
      provides: "Settings page with working API key save/load/delete via OS keychain"
      contains: "set_api_key"
    - path: "src/components/api_key_form.rs"
      provides: "Reusable API key input component with save/delete/status"
      contains: "ApiKeyForm"
    - path: "src/pages/health.rs"
      provides: "Health check page that calls backend and displays structured results"
      contains: "run_health_check"
    - path: "src/components/status_badge.rs"
      provides: "Status indicator component (pass/fail/unknown)"
      contains: "StatusBadge"
  key_links:
    - from: "src/pages/settings.rs"
      to: "src/commands.rs::set_api_key"
      via: "spawn_local calling invoke helper"
      pattern: "spawn_local.*set_api_key"
    - from: "src/pages/settings.rs"
      to: "src/commands.rs::get_api_key"
      via: "spawn_local calling invoke helper on mount"
      pattern: "spawn_local.*get_api_key"
    - from: "src/pages/health.rs"
      to: "src/commands.rs::run_health_check"
      via: "spawn_local calling invoke helper"
      pattern: "spawn_local.*run_health_check"
    - from: "src/commands.rs"
      to: "src-tauri/src/commands/keychain.rs"
      via: "Tauri invoke IPC"
      pattern: "invoke.*set_api_key"
---

<objective>
Wire the Settings page to the OS keychain for API key management, implement the Health Check page with live backend data, and produce a distributable macOS .dmg build.

Purpose: This completes Phase 1 by making the app functional -- API keys actually save to the macOS Keychain and persist across restarts, health check actually queries the system, and the app packages into a distributable DMG. After this plan, all Phase 1 success criteria are met.

Output: Working Settings page with keychain integration, working Health Check page with live system status, and a verified .dmg build artifact.
</objective>

<execution_context>
@/Users/michaelcurtis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelcurtis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-app-foundation/01-RESEARCH.md
@.planning/phases/01-app-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Settings page to OS keychain with API key management</name>
  <files>
    src/pages/settings.rs
    src/components/api_key_form.rs
    src/components/mod.rs
    style/main.css
  </files>
  <action>
    **src/components/api_key_form.rs** -- Reusable API key form component:
    - Props: service_name (String -- e.g., "Claude", "OpenAI"), service_id (String -- e.g., "bambumate-claude-api")
    - Internal state signals: key_value (String), is_saved (bool), is_loading (bool), error_message (Option<String>)
    - On component mount (use `leptos::spawn::spawn_local` in a create_effect or similar): call `commands::get_api_key(&service_id)` to check if a key exists. If Some, set is_saved=true and show "Key saved" status (do NOT display the actual key value for security). If None, show "Not configured".
    - Save button handler: call `commands::set_api_key(&service_id, &key_value)` via spawn_local. On success, set is_saved=true, clear the input field. On error, set error_message.
    - Delete button (only visible when is_saved=true): call `commands::delete_api_key(&service_id)` via spawn_local. On success, set is_saved=false.
    - UI: Label, password input, Save button, Delete button (conditional), status text ("Saved to Keychain" / "Not configured" / error)
    - Input uses type="password" so keys are masked while typing

    **src/pages/settings.rs** -- Wire settings page:
    - Replace placeholder content with actual form layout
    - Section "API Keys": Two ApiKeyForm instances:
      - Claude: service_name="Claude API Key", service_id="bambumate-claude-api"
      - OpenAI: service_name="OpenAI API Key", service_id="bambumate-openai-api"
    - Section "Application": Bambu Studio path preference field
      - Text input for custom Bambu Studio path (optional override)
      - Load current value from preferences on mount: `commands::get_preference("bambu_studio_path")`
      - Save on blur or button click: `commands::set_preference("bambu_studio_path", &value)`
      - Show detected default path as placeholder text

    **Update src/components/mod.rs**: Add `pub mod api_key_form;` export

    **Update style/main.css**: Add styles for:
    - Form sections with clear grouping (border, padding, heading)
    - Input fields: consistent width, padding, border styling
    - Password inputs: monospace font for key entry
    - Save/Delete buttons: distinct colors (save=blue/green, delete=red/muted)
    - Status indicators: green text for "Saved", gray for "Not configured", red for errors
    - Loading state: disabled appearance on buttons during async operations
  </action>
  <verify>
    1. `cd /Users/michaelcurtis/Development/BambuMate && cargo check` succeeds
    2. Verify src/components/api_key_form.rs contains spawn_local calls to set_api_key and get_api_key
    3. Verify src/pages/settings.rs creates two ApiKeyForm instances with correct service IDs
    4. Verify the service IDs match what the backend keychain.rs expects ("bambumate-claude-api", "bambumate-openai-api")
  </verify>
  <done>
    Settings page has two working API key forms that call the backend keychain commands via spawn_local + invoke. Each form loads existing key status on mount, saves new keys to OS Keychain, and can delete saved keys. Bambu Studio path preference saves via tauri-plugin-store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Health Check page with live system data and build DMG</name>
  <files>
    src/pages/health.rs
    src/components/status_badge.rs
    src/components/mod.rs
    style/main.css
  </files>
  <action>
    **src/components/status_badge.rs** -- Status indicator component:
    - Props: label (String), status (enum: Pass/Fail/Unknown), detail (Option<String>)
    - Renders: icon (checkmark for pass, X for fail, question mark for unknown) + label + optional detail text
    - Uses CSS classes for color coding: green/pass, red/fail, gray/unknown
    - Simple, reusable -- used by health check and potentially future status displays

    **src/pages/health.rs** -- Wire health check page:
    - Replace placeholder content with working health check UI
    - State signals: health_report (Option<HealthReport>), is_loading (bool), error (Option<String>)
    - "Run Health Check" button: on click, set is_loading=true, call `commands::run_health_check()` via spawn_local. On success, populate health_report. On error, set error message.
    - Results display (visible only when health_report is Some):
      - StatusBadge for "Bambu Studio": Pass if installed, show path in detail. Fail if not found.
      - StatusBadge for "Profile Directory": Pass if accessible, show path in detail. Fail if not found.
      - StatusBadge for "Claude API Key": Pass if configured, Fail if not.
      - StatusBadge for "OpenAI API Key": Pass if configured, Fail if not.
    - Summary line: "X of 4 checks passed" with appropriate color
    - Auto-run health check on page load (call run_health_check in a create_effect on mount) so user sees results immediately

    **Update src/components/mod.rs**: Add `pub mod status_badge;` export

    **Update style/main.css**: Add styles for:
    - Health check results: card-like display, each item in a row
    - Status badges: icon + text inline, color-coded
    - Summary bar: prominent pass/fail count
    - Loading spinner or "Checking..." text during health check

    **Build the DMG:**
    1. Install Trunk if not already installed: `cargo install trunk`
    2. Install wasm32 target if needed: `rustup target add wasm32-unknown-unknown`
    3. Run `cargo tauri build --bundles dmg` from the project root
    4. This will compile the frontend with Trunk, compile the backend with Cargo, and package into a DMG
    5. Verify the DMG exists at `src-tauri/target/release/bundle/dmg/BambuMate_0.1.0_aarch64.dmg` (or similar path depending on architecture)
    6. Note: The build may take several minutes. If it fails due to icon issues, generate icons with `cargo tauri icon` using a placeholder image, or provide minimal icon files.
    7. If code signing is not configured, the DMG will be unsigned -- this is expected for Phase 1. Document any signing warnings.

    **Important build notes:**
    - The DMG build MUST succeed. If there are compilation errors, fix them before proceeding.
    - If tauri-plugin-store has permission issues, ensure capabilities/default.json includes store permissions.
    - If keyring crate fails to compile, ensure apple-native feature is correctly specified in src-tauri/Cargo.toml.
  </action>
  <verify>
    1. `cd /Users/michaelcurtis/Development/BambuMate && cargo check` succeeds
    2. Verify src/pages/health.rs contains spawn_local call to run_health_check
    3. Verify src/components/status_badge.rs renders pass/fail/unknown states
    4. `ls src-tauri/target/release/bundle/dmg/*.dmg` shows the built DMG file exists
    5. DMG file size is reasonable (> 5MB, indicating it contains the app bundle)
  </verify>
  <done>
    Health check page calls the backend, displays live system status with pass/fail badges for all 4 checks. DMG build succeeds and produces a distributable macOS installer. All Phase 1 success criteria are met.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify app launches and all features work</name>
  <what-built>
    Complete Phase 1 BambuMate app with:
    1. Tauri 2.0 + Leptos app shell with sidebar navigation (Home, Settings, Health)
    2. Settings page with API key management via macOS Keychain
    3. Health check page with live system status
    4. macOS DMG build
  </what-built>
  <how-to-verify>
    1. Run `cd /Users/michaelcurtis/Development/BambuMate && cargo tauri dev` -- app window should open
    2. Verify sidebar shows Home, Settings, Health Check links
    3. Click each sidebar link -- pages should switch without errors
    4. Go to Settings page:
       a. Enter a test API key for Claude (any string like "test-key-123")
       b. Click Save -- should show "Saved to Keychain" status
       c. Reload the app (Cmd+R or restart) -- Settings should still show the Claude key as "Saved"
       d. Click Delete on the Claude key -- should show "Not configured"
    5. Go to Health Check page:
       a. Results should auto-load (or click "Run Health Check")
       b. Bambu Studio check: shows Pass if BS is installed, Fail if not (both are valid)
       c. API Key checks reflect what you saved in step 4
    6. Verify the DMG was built: `ls src-tauri/target/release/bundle/dmg/`
    7. (Optional) Mount the DMG and verify the app runs from it
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria verification:
1. "User can launch BambuMate on macOS and see the app window with a navigable shell" -- Verified by cargo tauri dev launching and sidebar navigation working
2. "User can enter and save API keys via a settings page, and keys persist across app restarts via OS keychain" -- Verified by saving a key, restarting, and seeing it's still saved
3. "User can run a health check that reports Bambu Studio installation status, profile directory accessibility, and API key configuration" -- Verified by health check page showing all 4 status items
4. "App builds to a distributable macOS .dmg" -- Verified by DMG file existing in build output
</verification>

<success_criteria>
- API keys save to macOS Keychain and persist across app restarts
- Health check displays live status for Bambu Studio, profile directory, and both API keys
- DMG build succeeds and produces an installer file
- All frontend-to-backend invoke calls work without __TAURI__ undefined errors
- User confirms visual and functional correctness via checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-app-foundation/01-02-SUMMARY.md`
</output>
