---
phase: 04-profile-generation-installation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/src/profile/generator.rs
  - src-tauri/src/profile/mod.rs
  - src-tauri/src/commands/profile.rs
  - src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Given a FilamentSpecs and a ProfileRegistry, the generator produces a fully-flattened FilamentProfile with all ~139 fields, inherits set to empty string, and scraped values overriding the correct fields"
    - "Generated profile has unique filament_id (P + 7 hex) and setting_id (PFUS + 14 hex) that do not collide with system IDs"
    - "All array fields in the generated profile have exactly 2 elements for dual-extruder compatibility"
    - "Process detection correctly reports whether Bambu Studio is running on macOS via pgrep"
    - "Tauri generate_profile command returns a preview with profile name, field count, base profile used, and BS running status"
    - "Tauri install_profile command writes profile + metadata atomically to the correct user filament directory"
  artifacts:
    - path: "src-tauri/src/profile/generator.rs"
      provides: "ProfileGenerator: generate_profile(), apply_specs_to_profile(), base_profile_name(), ID generation, is_bambu_studio_running()"
      exports: ["generate_profile", "is_bambu_studio_running", "base_profile_name"]
    - path: "src-tauri/src/commands/profile.rs"
      provides: "Extended with generate_profile_from_specs and install_generated_profile Tauri commands"
      contains: "generate_profile_from_specs"
    - path: "src-tauri/src/lib.rs"
      provides: "Two new commands registered in generate_handler"
      contains: "generate_profile_from_specs"
  key_links:
    - from: "src-tauri/src/profile/generator.rs"
      to: "src-tauri/src/profile/registry.rs"
      via: "ProfileRegistry::get_by_name() to load base profile"
      pattern: "registry\\.get_by_name"
    - from: "src-tauri/src/profile/generator.rs"
      to: "src-tauri/src/profile/inheritance.rs"
      via: "resolve_inheritance() to flatten base profile"
      pattern: "resolve_inheritance"
    - from: "src-tauri/src/commands/profile.rs"
      to: "src-tauri/src/profile/generator.rs"
      via: "generate_profile() called from Tauri command"
      pattern: "generator::generate_profile"
    - from: "src-tauri/src/commands/profile.rs"
      to: "src-tauri/src/profile/writer.rs"
      via: "write_profile_with_metadata() for installation"
      pattern: "write_profile_with_metadata"
---

<objective>
Build the backend profile generation engine and Tauri commands that transform scraped FilamentSpecs into fully-flattened Bambu Studio profiles and install them to the correct user directory.

Purpose: This is the core value delivery -- bridging the scraper (Phase 3) and profile engine (Phase 2) so users go from "filament name" to "installed profile" programmatically.
Output: generator.rs module with mapping logic + ID generation + process detection, and 2 new Tauri commands (generate_profile_from_specs, install_generated_profile).
</objective>

<execution_context>
@/Users/michaelcurtis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelcurtis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-profile-generation-installation/04-RESEARCH.md
@.planning/phases/02-profile-engine/02-01-SUMMARY.md
@.planning/phases/02-profile-engine/02-02-SUMMARY.md
@.planning/phases/03-filament-scraping/03-02-SUMMARY.md

# Key source files to read before implementing
@src-tauri/src/profile/types.rs
@src-tauri/src/profile/inheritance.rs
@src-tauri/src/profile/registry.rs
@src-tauri/src/profile/writer.rs
@src-tauri/src/profile/paths.rs
@src-tauri/src/profile/mod.rs
@src-tauri/src/scraper/types.rs
@src-tauri/src/commands/profile.rs
@src-tauri/src/commands/scraper.rs
@src-tauri/src/lib.rs
@src-tauri/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile generator module with spec-to-profile mapping, ID generation, and process detection</name>
  <files>
    src-tauri/Cargo.toml
    src-tauri/src/profile/generator.rs
    src-tauri/src/profile/mod.rs
  </files>
  <action>
1. Add `rand = "0.9"` to `[dependencies]` in `src-tauri/Cargo.toml`.

2. Create `src-tauri/src/profile/generator.rs` with:

   a) **`base_profile_name(material: &MaterialType) -> &'static str`**: Maps MaterialType variants to Bambu Studio base profile names. PLA->"Generic PLA", PETG->"Generic PETG", ABS->"Generic ABS", ASA->"Generic ASA", TPU->"Generic TPU", Nylon->"Generic PA", PC->"Generic PC", PVA->"Generic PVA", HIPS->"Generic HIPS", Other(_)->"Generic PLA" (safe fallback).

   b) **`generate_filament_id() -> String`**: Uses `rand::random::<[u8; 4]>()`, formats as `"P"` + 7 hex chars: `format!("P{:07x}", u32::from_be_bytes(bytes) & 0x0FFFFFFF)`.

   c) **`generate_setting_id() -> String`**: Uses `rand::random::<[u8; 7]>()`, formats as `"PFUS"` + 14 hex chars using `format!("{:02x}", byte)` per byte (no hex crate dependency).

   d) **`apply_specs_to_profile(profile: &mut FilamentProfile, specs: &FilamentSpecs)`**: Maps scraped spec fields to BS profile fields. Use a local helper closure `set_dual` that calls `profile.set_string_array(key, vec![val.clone(), val])` to always produce 2-element arrays. Field mapping:
      - `nozzle_temp_max` -> `nozzle_temperature`, `nozzle_temperature_initial_layer` (max + 5)
      - `nozzle_temp_max` -> `nozzle_temperature_range_high` (max + 20)
      - `nozzle_temp_min` -> `nozzle_temperature_range_low`
      - `bed_temp_max` -> `bed_temperature`, `bed_temperature_initial_layer`, `hot_plate_temp`, `hot_plate_temp_initial_layer`, `eng_plate_temp`, `eng_plate_temp_initial_layer`
      - `bed_temp_min` -> `cool_plate_temp`, `cool_plate_temp_initial_layer`, `textured_plate_temp` (min - 5, floored at 0), `textured_plate_temp_initial_layer`
      - `fan_speed_percent` -> `fan_max_speed` (format as "{}%"), `fan_min_speed` (60% of max, format as "{}%")
      - `retraction_distance_mm` -> `filament_retraction_length` (format "{:.1}")
      - `retraction_speed_mm_s` -> `filament_retraction_speed`
      - `density_g_cm3` -> `filament_density` (format "{:.2}")
      - `specs.material` -> `filament_type` (via set_dual)
      - `specs.brand` -> `filament_vendor` (via set_dual)

   e) **`generate_profile(specs: &FilamentSpecs, registry: &ProfileRegistry, target_printer: Option<&str>) -> Result<(FilamentProfile, ProfileMetadata, String)>`**: The main function. Returns (profile, metadata, filename). Steps:
      1. Determine material type via `MaterialType::from_str(&specs.material)`
      2. Get base profile name via `base_profile_name(&material)`
      3. Look up base profile via `registry.get_by_name(base_name)` -- return error if not found
      4. Clone and resolve via `resolve_inheritance(&base, registry)?` to get fully-flattened profile
      5. Set identity fields: `name` as `"{brand} {material} {name} @{printer}"` (default printer: "Bambu Lab H2C 0.4 nozzle"), `inherits` as empty string, `from` as "User", `filament_id` via generate_filament_id(), `instantiation` as "true"
      6. Set `filament_settings_id` as 2-element array with the profile name
      7. Call `apply_specs_to_profile(&mut profile, specs)`
      8. Set `compatible_printers` as empty array `[]` (universal compatibility)
      9. Generate metadata: `ProfileMetadata { sync_info: String::new(), user_id: paths.preset_folder from caller, setting_id: generate_setting_id(), base_id: String::new(), updated_time: chrono::Utc::now().timestamp() as u64 }`
      10. Generate filename: `"{brand} {material} {name} @{printer}.json"`
      11. Return tuple

   f) **`is_bambu_studio_running() -> bool`**: Platform-conditional process detection.
      - `#[cfg(target_os = "macos")]`: Use `std::process::Command::new("pgrep").arg("-f").arg("BambuStudio")` with stdout/stderr piped to null, check `status().success()`
      - `#[cfg(target_os = "windows")]`: Stub returning false
      - `#[cfg(target_os = "linux")]`: Same pgrep approach as macOS
      - `#[cfg(not(any(...)))]`: Return false

   **Important constraints:**
   - Do NOT use the `hex` crate -- use `format!("{:02x}", byte)` for hex encoding
   - All array fields MUST have exactly 2 elements (dual-extruder compatibility)
   - The profile MUST have `inherits: ""` (fully flattened, not inheriting)
   - User profile IDs use "P" prefix (filament_id) and "PFUS" prefix (setting_id) -- NOT "GFL"/"GFS" system prefixes

3. Update `src-tauri/src/profile/mod.rs`: Add `pub mod generator;` and re-export `generator::generate_profile` and `generator::is_bambu_studio_running`.
  </action>
  <verify>
Run `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo check 2>&1` -- should compile with zero errors. Warnings about unused functions are acceptable since commands haven't been wired yet.
  </verify>
  <done>
generator.rs exists with generate_profile, apply_specs_to_profile, base_profile_name, generate_filament_id, generate_setting_id, is_bambu_studio_running. All compile cleanly. rand 0.9 added to Cargo.toml. Module wired in profile/mod.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add generate and install Tauri commands</name>
  <files>
    src-tauri/src/commands/profile.rs
    src-tauri/src/lib.rs
  </files>
  <action>
Extend `src-tauri/src/commands/profile.rs` with two new Tauri commands and their response types.

1. **Add new response structs** (at top of file, alongside existing ProfileInfo/ProfileDetail):

   ```rust
   #[derive(Debug, Clone, Serialize)]
   pub struct GenerateResult {
       pub profile_name: String,
       pub profile_json: String,        // Full JSON for install step
       pub metadata_info: String,        // Full .info content for install step
       pub filename: String,             // Target filename
       pub field_count: usize,
       pub base_profile_used: String,
       pub specs_applied: GeneratedSpecs,
       pub warnings: Vec<String>,
       pub bambu_studio_running: bool,
   }

   #[derive(Debug, Clone, Serialize)]
   pub struct GeneratedSpecs {
       pub nozzle_temp: Option<String>,
       pub bed_temp: Option<String>,
       pub fan_speed: Option<String>,
       pub retraction: Option<String>,
   }

   #[derive(Debug, Clone, Serialize)]
   pub struct InstallResult {
       pub installed_path: String,
       pub profile_name: String,
       pub bambu_studio_was_running: bool,
   }
   ```

2. **Add `generate_profile_from_specs` command:**
   - Signature: `pub async fn generate_profile_from_specs(specs: crate::scraper::types::FilamentSpecs, target_printer: Option<String>) -> Result<GenerateResult, String>`
   - Steps:
     a. Detect BambuPaths -- return user-friendly error if BS not installed
     b. Build ProfileRegistry from system filament dir
     c. Call `crate::profile::generator::generate_profile(&specs, &registry, target_printer.as_deref())`
     d. Serialize profile to JSON via `to_json_4space()`
     e. Serialize metadata via `to_info_string()`
     f. Check `is_bambu_studio_running()`
     g. Build `GeneratedSpecs` from the input specs for UI display
     h. Return `GenerateResult` with all data
   - Add any warnings: e.g., if BS is running, add "Bambu Studio is running. Profile changes may not take effect until BS is restarted."

3. **Add `install_generated_profile` command:**
   - Signature: `pub async fn install_generated_profile(profile_json: String, metadata_info: String, filename: String, force: bool) -> Result<InstallResult, String>`
   - Steps:
     a. Parse `profile_json` back into `FilamentProfile::from_json()`
     b. Parse `metadata_info` back into `ProfileMetadata::from_info_string()`
     c. Check `is_bambu_studio_running()`. If running and `force` is false, return error "Bambu Studio is running. Use force=true to install anyway, but restart BS to see changes."
     d. Detect BambuPaths
     e. Get user_filament_dir() -- return error if not found
     f. Build target path: `user_filament_dir.join(&filename)`
     g. Check if file already exists -- add warning to result if overwriting
     h. Call `write_profile_with_metadata(&profile, &target_path, &metadata)`
     i. Return `InstallResult` with installed path, profile name, and BS running status

4. **Register both commands in `src-tauri/src/lib.rs`:**
   Add `commands::profile::generate_profile_from_specs` and `commands::profile::install_generated_profile` to the `generate_handler![]` macro invocation.

**Important:** Both commands must use `#[tauri::command]` attribute. The generate command does NOT write anything -- it returns data for preview. The install command does the actual write. This two-step flow lets the UI show a preview before committing.

**Error handling pattern:** Follow existing pattern in commands/scraper.rs -- `.map_err(|e| e.to_string())` for all fallible operations.
  </action>
  <verify>
Run `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo check 2>&1` -- should compile with zero errors. Also run `cargo test 2>&1` to confirm existing tests still pass.
  </verify>
  <done>
Two new Tauri commands (generate_profile_from_specs, install_generated_profile) exist in commands/profile.rs and are registered in lib.rs (total 15 commands). `cargo check` passes. Existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo check` -- zero compilation errors
2. `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo test` -- all existing tests pass (profile round-trip, scraper validation, etc.)
3. `grep -r "generate_profile_from_specs" src-tauri/src/` shows the function in generator.rs, commands/profile.rs, and lib.rs
4. `grep -r "install_generated_profile" src-tauri/src/` shows the function in commands/profile.rs and lib.rs
5. `grep "rand" src-tauri/Cargo.toml` confirms rand dependency added
</verification>

<success_criteria>
- generator.rs module creates fully-flattened profiles from FilamentSpecs with correct ID generation
- is_bambu_studio_running() detects BS process on macOS
- generate_profile_from_specs Tauri command returns preview data without writing files
- install_generated_profile Tauri command writes profile + metadata atomically with BS-running check
- All existing tests continue to pass
- Total registered Tauri commands: 15 (13 existing + 2 new)
</success_criteria>

<output>
After completion, create `.planning/phases/04-profile-generation-installation/04-01-SUMMARY.md`
</output>
