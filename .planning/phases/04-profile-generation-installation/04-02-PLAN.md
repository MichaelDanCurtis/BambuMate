---
phase: 04-profile-generation-installation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/commands.rs
  - src/pages/filament_search.rs
  - src/pages/mod.rs
  - src/components/filament_card.rs
  - src/components/profile_preview.rs
  - src/components/mod.rs
  - src/app.rs
  - src/components/sidebar.rs
autonomous: false

must_haves:
  truths:
    - "User can type a filament name in the search page and see structured specs (temps, speeds, cooling, retraction) after search completes"
    - "User can click Generate to produce a profile preview showing the profile name, base profile used, field count, and key overrides"
    - "User can click Install to write the generated profile to the Bambu Studio user directory"
    - "If Bambu Studio is running during generation or installation, the user sees a visible warning"
    - "Filament Search appears in the sidebar navigation and is accessible at /filament route"
  artifacts:
    - path: "src/commands.rs"
      provides: "Frontend invoke wrappers for search_filament, generate_profile_from_specs, install_generated_profile"
      contains: "generate_profile_from_specs"
    - path: "src/pages/filament_search.rs"
      provides: "FilamentSearchPage component with search input, results, generate button, install button"
      contains: "FilamentSearchPage"
    - path: "src/components/filament_card.rs"
      provides: "FilamentCard component displaying scraped specs"
      contains: "FilamentCard"
    - path: "src/components/profile_preview.rs"
      provides: "ProfilePreview component displaying generated profile details with install action"
      contains: "ProfilePreview"
    - path: "src/app.rs"
      provides: "Route for /filament path"
      contains: "filament"
    - path: "src/components/sidebar.rs"
      provides: "Filament Search nav item"
      contains: "Filament Search"
  key_links:
    - from: "src/pages/filament_search.rs"
      to: "src/commands.rs"
      via: "invoke wrapper calls for search and generate"
      pattern: "commands::search_filament"
    - from: "src/commands.rs"
      to: "Tauri backend"
      via: "wasm_bindgen invoke for generate_profile_from_specs"
      pattern: "invoke.*generate_profile_from_specs"
    - from: "src/app.rs"
      to: "src/pages/filament_search.rs"
      via: "Route component mapping /filament to FilamentSearchPage"
      pattern: "filament.*FilamentSearchPage"
---

<objective>
Build the filament search UI page with the end-to-end workflow: search for a filament by name, view scraped specs, generate a Bambu Studio profile preview, and install it -- all from one page.

Purpose: This delivers the user-facing feature that makes Phase 4's backend useful. The user gets a single page that replaces the manual workflow of researching filament settings and creating profiles by hand.
Output: FilamentSearchPage with search input, FilamentCard specs display, ProfilePreview with install button, plus routing and navigation integration.
</objective>

<execution_context>
@/Users/michaelcurtis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelcurtis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-profile-generation-installation/04-RESEARCH.md
@.planning/phases/04-profile-generation-installation/04-01-SUMMARY.md

# Key source files
@src/commands.rs
@src/app.rs
@src/components/sidebar.rs
@src/components/mod.rs
@src/pages/mod.rs
@src/pages/home.rs
@src/pages/health.rs
@src/pages/settings.rs
@src/theme.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add frontend command wrappers for search, generate, and install</name>
  <files>
    src/commands.rs
  </files>
  <action>
Extend `src/commands.rs` with invoke wrappers for the three Tauri commands needed by the filament search page. Follow the existing pattern in commands.rs (arg structs, serde_wasm_bindgen, invoke, deserialize result).

1. **Add types matching backend response structs:**

   ```rust
   #[derive(Debug, Clone, Deserialize, Serialize)]
   pub struct FilamentSpecs {
       pub name: String,
       pub brand: String,
       pub material: String,
       pub nozzle_temp_min: Option<u16>,
       pub nozzle_temp_max: Option<u16>,
       pub bed_temp_min: Option<u16>,
       pub bed_temp_max: Option<u16>,
       pub max_speed_mm_s: Option<u16>,
       pub fan_speed_percent: Option<u8>,
       pub retraction_distance_mm: Option<f32>,
       pub retraction_speed_mm_s: Option<u16>,
       pub density_g_cm3: Option<f32>,
       pub diameter_mm: Option<f32>,
       pub source_url: String,
       pub extraction_confidence: f32,
   }

   #[derive(Debug, Clone, Deserialize, Serialize)]
   pub struct GeneratedSpecs {
       pub nozzle_temp: Option<String>,
       pub bed_temp: Option<String>,
       pub fan_speed: Option<String>,
       pub retraction: Option<String>,
   }

   #[derive(Debug, Clone, Deserialize, Serialize)]
   pub struct GenerateResult {
       pub profile_name: String,
       pub profile_json: String,
       pub metadata_info: String,
       pub filename: String,
       pub field_count: usize,
       pub base_profile_used: String,
       pub specs_applied: GeneratedSpecs,
       pub warnings: Vec<String>,
       pub bambu_studio_running: bool,
   }

   #[derive(Debug, Clone, Deserialize, Serialize)]
   pub struct InstallResult {
       pub installed_path: String,
       pub profile_name: String,
       pub bambu_studio_was_running: bool,
   }
   ```

2. **Add arg structs:**
   - `SearchFilamentArgs { filament_name: String }`
   - `GenerateProfileArgs { specs: FilamentSpecs, target_printer: Option<String> }`
   - `InstallProfileArgs { profile_json: String, metadata_info: String, filename: String, force: bool }`

3. **Add three async invoke wrapper functions:**

   a) `pub async fn search_filament(name: &str) -> Result<FilamentSpecs, String>` -- invokes "search_filament" with `SearchFilamentArgs`

   b) `pub async fn generate_profile(specs: &FilamentSpecs, target_printer: Option<String>) -> Result<GenerateResult, String>` -- invokes "generate_profile_from_specs" with `GenerateProfileArgs`

   c) `pub async fn install_profile(profile_json: &str, metadata_info: &str, filename: &str, force: bool) -> Result<InstallResult, String>` -- invokes "install_generated_profile" with `InstallProfileArgs`

Follow the exact pattern used by existing functions like `run_health_check` and `set_api_key`: serialize args with serde_wasm_bindgen, invoke, deserialize result with serde_wasm_bindgen.
  </action>
  <verify>
Run `cd /Users/michaelcurtis/Development/BambuMate && trunk build 2>&1` or `cargo check -p bambumate 2>&1` from the project root. If trunk is not available, just run `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo check 2>&1` to verify the backend still compiles (frontend WASM compilation requires trunk).
  </verify>
  <done>
commands.rs has FilamentSpecs, GenerateResult, InstallResult types and three invoke wrapper functions (search_filament, generate_profile, install_profile). Backend still compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create filament search page with specs display, profile generation, and install flow</name>
  <files>
    src/pages/filament_search.rs
    src/pages/mod.rs
    src/components/filament_card.rs
    src/components/profile_preview.rs
    src/components/mod.rs
    src/app.rs
    src/components/sidebar.rs
  </files>
  <action>
Build the complete filament search UI as a new page with supporting components.

1. **Create `src/components/filament_card.rs`** -- A component that displays FilamentSpecs in a readable card format:
   - Takes `specs: crate::commands::FilamentSpecs` as a prop
   - Displays: brand, name, material type
   - Displays a specs grid with: nozzle temp range (min-max), bed temp range, max speed, fan speed, retraction distance + speed, density, diameter
   - Handles None values gracefully with "N/A" or "--"
   - Shows extraction confidence as a percentage bar or badge
   - Shows source URL as a small link
   - Use CSS classes prefixed with `filament-card-` for styling
   - Include a "Generate Profile" button at the bottom that takes an `on_generate: Callback<()>` prop

2. **Create `src/components/profile_preview.rs`** -- A component that displays GenerateResult for user review before install:
   - Takes `result: crate::commands::GenerateResult` as a prop
   - Displays: profile_name, base_profile_used, field_count
   - Shows specs_applied section (nozzle temp, bed temp, fan speed, retraction)
   - Displays warnings in a yellow/amber warning box if `warnings` is non-empty
   - Shows a prominent warning banner if `bambu_studio_running` is true: "Bambu Studio is running. Restart BS after installation for changes to take effect."
   - Has an "Install Profile" button that takes an `on_install: Callback<()>` prop
   - Has a "Cancel" button that takes an `on_cancel: Callback<()>` prop

3. **Update `src/components/mod.rs`:** Add `pub mod filament_card;` and `pub mod profile_preview;`.

4. **Create `src/pages/filament_search.rs`** -- The main search page with full workflow:
   - Uses Leptos signals for state management:
     - `search_query: RwSignal<String>` -- the text input
     - `search_result: RwSignal<Option<Result<FilamentSpecs, String>>>` -- search results
     - `is_searching: RwSignal<bool>` -- loading state for search
     - `generate_result: RwSignal<Option<Result<GenerateResult, String>>>` -- generation result
     - `is_generating: RwSignal<bool>` -- loading state for generate
     - `install_result: RwSignal<Option<Result<InstallResult, String>>>` -- install result
     - `is_installing: RwSignal<bool>` -- loading state for install

   - **Search flow:**
     - Text input with placeholder "e.g., Polymaker PLA Pro"
     - "Search" button that triggers search (disabled when query < 3 chars or is_searching)
     - On click: set is_searching=true, spawn_local async block calling `commands::search_filament`, set result, set is_searching=false
     - Show loading spinner/text when is_searching
     - On success: render FilamentCard component with the specs
     - On error: show error message in red

   - **Generate flow:**
     - FilamentCard's "Generate Profile" button triggers generation
     - On click: set is_generating=true, spawn_local calling `commands::generate_profile(&specs, None)`, set generate_result, set is_generating=false
     - On success: render ProfilePreview component
     - On error: show error message

   - **Install flow:**
     - ProfilePreview's "Install Profile" button triggers installation
     - On click: set is_installing=true, spawn_local calling `commands::install_profile(...)` with force=true (since we already show the warning), set install_result, set is_installing=false
     - On success: show green success message with installed path
     - On error: show error message

   - **Layout:** Vertical flow -- search bar at top, results below, generate preview below that, install result at bottom. Each step appears after the previous succeeds.

   - **CSS classes:** Use `filament-search-page`, `search-bar`, `search-button`, `search-results`, `generate-section`, `install-section`, `success-message`, `error-message`, `warning-message`, `loading-spinner`

   - **Styling:** Add basic inline or scoped CSS for the page. Follow the existing dark theme CSS variables from the project (--bg-primary, --bg-secondary, --text-primary, --accent-primary). Keep it clean and functional -- not pixel-perfect.

5. **Update `src/pages/mod.rs`:** Add `pub mod filament_search;`.

6. **Update `src/app.rs`:**
   - Add import: `use crate::pages::filament_search::FilamentSearchPage;`
   - Add route inside `<Routes>`: `<Route path=path!("/filament") view=FilamentSearchPage />`

7. **Update `src/components/sidebar.rs`:**
   - Add a new nav item between "Home" and "Settings":
     ```html
     <li class="nav-item">
         <a href="/filament" class="nav-link">"Filament Search"</a>
     </li>
     ```

**CSS note:** Add a `<style>` block in the filament_search.rs view or create styles in the existing global CSS. The page should look reasonable with the existing dark theme. Key visual needs:
- Search input should be full-width with padding
- FilamentCard should be a bordered card with grid layout for specs
- ProfilePreview should show profile details in a clean format
- Warning banners should be visually distinct (amber/yellow background)
- Success message should be green
- Buttons should match existing app button style
  </action>
  <verify>
Run `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo check 2>&1` to verify backend still compiles. Then check that all new files exist and have the expected exports:
- `grep "FilamentSearchPage" src/pages/filament_search.rs`
- `grep "FilamentCard" src/components/filament_card.rs`
- `grep "ProfilePreview" src/components/profile_preview.rs`
- `grep "filament" src/app.rs` confirms route added
- `grep "Filament Search" src/components/sidebar.rs` confirms nav added
  </verify>
  <done>
FilamentSearchPage exists with complete search->generate->install flow. FilamentCard displays scraped specs. ProfilePreview shows generated profile with warnings. Route at /filament works. Sidebar has "Filament Search" nav item.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete filament search and profile generation UI. Users can search for a filament, view specs, generate a Bambu Studio profile, and install it.</what-built>
  <how-to-verify>
1. Run the app: `cd /Users/michaelcurtis/Development/BambuMate && cargo tauri dev`
2. Verify "Filament Search" appears in the sidebar navigation
3. Click "Filament Search" -- should navigate to the search page
4. Type a filament name (e.g., "Polymaker PLA Pro") and click Search
5. Verify specs display correctly in a card format (temps, speeds, etc.)
6. Click "Generate Profile" -- verify preview shows profile name, base profile, field count
7. If Bambu Studio is running, verify a warning banner appears
8. Click "Install Profile" -- verify success message with installed path
9. Check Bambu Studio: restart BS and look for the new filament in the filament list
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Backend compiles: `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo check`
2. Backend tests pass: `cd /Users/michaelcurtis/Development/BambuMate/src-tauri && cargo test`
3. All new files exist with correct exports
4. Route accessible at /filament
5. End-to-end flow works: search -> view specs -> generate -> preview -> install -> success
6. BS-running warning displays when applicable
</verification>

<success_criteria>
- User can navigate to /filament from sidebar
- User can search for a filament and see structured specs
- User can generate a profile preview from search results
- User sees BS-running warning if Bambu Studio is active
- User can install the generated profile
- Success message shows the installed file path
- Generated profile appears in Bambu Studio after restart
</success_criteria>

<output>
After completion, create `.planning/phases/04-profile-generation-installation/04-02-SUMMARY.md`
</output>
