---
phase: 07-auto-tuning-refinement
plan: 04
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/components/history_panel.rs
  - src/components/mod.rs
  - src/pages/print_analysis.rs
  - styles/history_panel.css
autonomous: false

must_haves:
  truths:
    - "User can view history of past analysis sessions"
    - "User can revert to a previous profile state"
  artifacts:
    - path: "src/components/history_panel.rs"
      provides: "HistoryPanel component for refinement history"
      min_lines: 60
    - path: "src/pages/print_analysis.rs"
      provides: "History panel integration"
      contains: "HistoryPanel"
  key_links:
    - from: "src/components/history_panel.rs"
      to: "src/commands.rs::list_history_sessions"
      via: "Resource fetch"
      pattern: "list_history_sessions"
    - from: "src/components/history_panel.rs"
      to: "src/commands.rs::revert_to_backup"
      via: "Revert button click"
      pattern: "revert_to_backup"
---

<objective>
Build the HistoryPanel component for viewing past analysis sessions and reverting to previous profile states.

Purpose: This completes the refinement history UI. Users can see their past sessions for a profile and revert if a change made things worse.

Output: HistoryPanel component with session list and revert capability, integrated into print_analysis page.
</objective>

<execution_context>
@/Users/michaelcurtis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelcurtis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-auto-tuning-refinement/07-RESEARCH.md
@.planning/phases/07-auto-tuning-refinement/07-02-PLAN.md
@.planning/phases/07-auto-tuning-refinement/07-03-PLAN.md
@src/pages/print_analysis.rs
@src/commands.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HistoryPanel component</name>
  <files>
    src/components/history_panel.rs
    src/components/mod.rs
    styles/history_panel.css
  </files>
  <action>
**Create HistoryPanel component (history_panel.rs):**
```rust
//! History panel showing refinement sessions.

use leptos::prelude::*;
use wasm_bindgen_futures::spawn_local;
use crate::commands::{self, SessionSummary};

#[component]
pub fn HistoryPanel(
    profile_path: String,
    on_revert: Callback<i64>,  // session_id
) -> impl IntoView {
    let (sessions, set_sessions) = signal::<Option<Vec<SessionSummary>>>(None);
    let (loading, set_loading) = signal(true);
    let (error, set_error) = signal::<Option<String>>(None);

    // Load sessions on mount
    {
        let path = profile_path.clone();
        spawn_local(async move {
            match commands::list_history_sessions(path).await {
                Ok(s) => set_sessions.set(Some(s)),
                Err(e) => set_error.set(Some(e)),
            }
            set_loading.set(false);
        });
    }

    view! {
        <div class="history-panel">
            <style>{include_str!("history_panel.css")}</style>
            <h4>"Refinement History"</h4>

            {move || {
                if loading.get() {
                    view! { <p class="loading">"Loading history..."</p> }.into_any()
                } else if let Some(err) = error.get() {
                    view! { <p class="error">{err}</p> }.into_any()
                } else if let Some(sessions) = sessions.get() {
                    if sessions.is_empty() {
                        view! { <p class="no-history">"No history for this profile yet."</p> }.into_any()
                    } else {
                        view! {
                            <div class="history-list">
                                {sessions.iter().map(|s| {
                                    let id = s.id;
                                    let date = s.created_at.clone();
                                    let applied = s.was_applied;
                                    view! {
                                        <div class="history-item">
                                            <span class="history-date">{date}</span>
                                            <span class="history-status">
                                                {if applied { "[Applied]" } else { "[Analyzed]" }}
                                            </span>
                                            {applied.then(|| view! {
                                                <button
                                                    class="btn btn-small btn-secondary"
                                                    on:click=move |_| on_revert.call(id)
                                                >
                                                    "Revert"
                                                </button>
                                            })}
                                        </div>
                                    }
                                }).collect::<Vec<_>>()}
                            </div>
                        }.into_any()
                    }
                } else {
                    view! { <p>"No data"</p> }.into_any()
                }
            }}
        </div>
    }
}
```

Update components/mod.rs to add: `pub mod history_panel;`

**Create styles/history_panel.css** with appropriate styling:
- Panel container with dark theme background
- List layout for sessions
- Date formatting
- Status badges (Applied vs Analyzed)
- Revert button styling (small, secondary)
- Empty state and loading state styling
  </action>
  <verify>
`trunk build` compiles without errors.
  </verify>
  <done>
HistoryPanel component displays sessions with dates, status badges, and Revert buttons for applied sessions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate HistoryPanel into print_analysis page</name>
  <files>src/pages/print_analysis.rs</files>
  <action>
**Add HistoryPanel to print_analysis.rs:**

1. Import the component:
```rust
use crate::components::history_panel::HistoryPanel;
```

2. Add revert handling state and callback:
```rust
let (revert_message, set_revert_message) = signal::<Option<String>>(None);
```

3. In the Complete state, when profile_path is provided, show HistoryPanel in a sidebar or below the analysis:
```rust
{profile_path.get().map(|path| {
    let on_revert = Callback::new(move |session_id: i64| {
        spawn_local(async move {
            match commands::revert_to_backup(session_id).await {
                Ok(msg) => {
                    set_revert_message.set(Some(format!("Success: {}", msg)));
                    // Optionally refresh the history panel
                }
                Err(e) => {
                    set_revert_message.set(Some(format!("Error: {}", e)));
                }
            }
        });
    });

    view! {
        <div class="history-sidebar">
            <HistoryPanel
                profile_path=path
                on_revert=on_revert
            />
            {move || revert_message.get().map(|msg| view! {
                <p class="revert-message">{msg}</p>
            })}
        </div>
    }
})}
```

4. Add CSS for history sidebar positioning (either inline or in main.css):
```css
.history-sidebar {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}
.revert-message {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
}
```
  </action>
  <verify>
`trunk build` compiles without errors.
  </verify>
  <done>
HistoryPanel appears on print_analysis page when profile_path is provided.
Revert button triggers revert_to_backup command and shows result message.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete auto-apply flow with backup creation, change preview dialog, and refinement history panel with revert capability.
  </what-built>
  <how-to-verify>
1. Run `cargo tauri dev` to launch the app
2. Navigate to Print Analysis page
3. Upload a test print photo
4. Enter a profile path (e.g., an existing Bambu Studio profile)
5. Click "Analyze Print"
6. After analysis completes, verify:
   - "Apply Changes to Profile" button is visible
   - session_id is logged or stored (check console if needed)
7. Click "Apply Changes to Profile"
8. Verify the ChangePreview dialog appears with selectable changes
9. Toggle some checkboxes to verify selection works
10. Click "Apply" and verify:
    - A .backups/ folder is created in the profile's directory
    - A timestamped backup file exists
    - The profile JSON is modified with new values
11. Check the History panel shows the session with [Applied] status
12. Click "Revert" on the applied session
13. Verify the profile is restored to pre-apply state

Expected: User can apply changes with confirmation, backup is created, history tracks the session, revert restores from backup.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `trunk build` - compiles without errors
2. HistoryPanel shows sessions with Revert buttons
3. Revert button invokes revert_to_backup command
4. Success/error messages display after revert
</verification>

<success_criteria>
- History panel shows past sessions for the profile
- Sessions display date and applied/analyzed status
- Revert button appears only for applied sessions
- Revert restores profile from backup
- User sees feedback after revert operation
</success_criteria>

<output>
After completion, create `.planning/phases/07-auto-tuning-refinement/07-04-SUMMARY.md`
</output>
